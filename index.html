<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>PDFdiff</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: ヒラギノ角ゴ Pro, Noto Sans JP, Arial, sans-serif;
            height: 100dvh;
            overflow: hidden;
            touch-action: none;
        }

        /* 修正：高さを固定せず、Canvasに合わせて広がるようにする */
        .comparison-container {
            position: relative;
            overflow: hidden;
            /* min-heightを削除するか、表示を安定させるために自動に */
            border: 1px solid #ccc;
            background: #eee;
            margin: 0 auto;
            /* 中央寄せ */
        }

        /* 修正：Canvasレイヤーの設定 */
        .canvas-layer {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            /* 中央配置 */
            display: block;
        }

        /* 追加：Canvasが絶対配置なので親要素に高さを確保するためのヘルパー */
        #comp-box {
            transition: width 0.2s, height 0.2s;
        }

        canvas {

            height: 100%;
        }

        #slider {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 4px;
            background: #2563eb;
            cursor: ew-resize;
            z-index: 10;
        }

        #slider::after {
            content: '↔';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #2563eb;
            color: white;
            padding: 5px;
            border-radius: 50%;
            font-size: 12px;
        }

        .diff-overlay {
            mix-blend-mode: difference;
        }

        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s ease infinite;
        }

        .head1 {
            height: 40px;
            background: #efb6af;
            display: flex;
            flex-direction: row;
            padding-left: 20px;
            gap: 12px;
        }

        .head1 h1 {
            font-size: 16px;
            font-weight: bold;
            margin: 0;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .head1 p {
            margin: 0;
            color: #fff;
            font-size: 15px;
            cursor: pointer;
            height: 40px;
            display: flex;
            align-items: center;
            padding: 0 12px;
        }

        .head1 p:hover {
            background: #ba7d75;
        }

        .head1 h1::after {
            content: "|";
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .hidden {
            display: none;
        }

        .panels {
            gap: 20px;
            background-color: #f9f9ff;
            border-bottom: 3px solid gainsboro;
            height: 90px;
            padding-left: 20px;
            display: flex;
            align-items: center;
        }

        #controlpanel {
            display: none;
        }

        #fileinputpanel {
            display: flex;
            gap: 20px;
        }

        .flex {
            display: flex;
        }

        .items-center {
            align-items: center;
        }

        .gap-2 {
            gap: 0.5rem;
        }

        .squareicon {
            width: 16px;
            height: 16px;
            display: inline-block;
            border-radius: 10px;
        }

        .red {
            background-color: #ff6666;
        }

        .blue {
            background-color: #6666ff;
        }

        .purple {
            background-color: #cc66ff;
        }

        .flex-col {
            flex-direction: column;
        }

        .justify-center {
            justify-content: center;
        }

        .fip {
            height: 90%;
            display: flex;
            gap: 3px;
            font-size: 14px;
            flex-direction: column-reverse;
            align-items: center;
            border: 1px solid gainsboro;
            padding: 5px;
            border-radius: 3px;
        }


        .fip label {
            font-size: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .fip input[type="file"] {
            display: none;
        }

        /* ボタン部分 */
        .upload-file-icon-a {
            width: 40px;
            height: 40px;
            border-radius: 5px;
            background: #fff;
            cursor: pointer;
        }
        .upload-file-icon-a::before {
            content: "↑N";
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
        }
        .upload-file-icon-a.new-a::before {
            content: "↑O";
        }

        /* ファイル名表示 */
        .file-names {
            width: 60px;
            font-size: 5px;
            text-align: center;
            white-space: nowrap;
            text-overflow: ellipsis;
            overflow: hidden;
        }
    </style>
</head>

<body>

    <div>
        <header class="head1">
            <h1>PDFdiff - PDF比較ツール</h1>
            <p id="file-tab-btn">ファイル</p>
            <p id="option-tab-btn">オプション</p>
        </header>

        <div class="panels" id="panels">
            <div id="fileinputpanel">
                <div class="fip">
                    <label>
                        <div class="upload-file-icon-a old-a"></div>
                        <p>比較元 (旧)</p>
                        <input type="file" id="file-old" accept="application/pdf">
                        <div class="file-names"></div>
                    </label>
                </div>

                <div class="fip">
                    <label>
                        <div class="upload-file-icon-a new-a"></div>
                        <p>比較先 (新)</p>
                        <input type="file" id="file-new" accept="application/pdf">
                        <div class="file-names"></div>
                    </label>
                </div>
            </div>

            <!-- Controls -->
            <div id="controlpanel">
                <div class="flex items-center gap-6">
                    <label>
                        <input type="radio" name="mode" value="overlay" checked class="w-4 h-4 text-blue-600">
                        <span>重ね合わせ (差分)</span>
                    </label>
                    <label>
                        <input type="radio" name="mode" value="slider" class="w-4 h-4 text-blue-600">
                        <span>スライダー比較</span>
                    </label>
                    <label for="fullscreen-cbtn">
                        <input type="checkbox" id="fullscreen-cbtn">
                        <span>フルスクリーン表示</span>
                    </label>
                </div>
            </div>
        </div>
        <!-- Main Comparison Area -->
        <div id="status-message"
            class="text-center py-10 text-gray-400 border-2 border-dashed border-gray-200 rounded-xl">
            PDFファイルを2つ選択してください。
        </div>
        <div class="flex items-center gap-4">
            <button id="prev-page"
                class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300 disabled:opacity-50">前へ</button>
            <span class="font-medium">ページ: <span id="current-page">1</span> / <span id="total-pages">-</span></span>
            <button id="next-page"
                class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300 disabled:opacity-50">次へ</button>
        </div>
        <div id="viewer-container" class="hidden flex flex-col items-center justify-center">
            <div id="loading" class="hidden mb-4 items-center gap-2">
                <div class="loading-spinner"></div>
                <span>レンダリング中...</span>
            </div>

            <div class="comparison-container" id="comp-box">
                <canvas id="canvas-old" class="canvas-layer"></canvas>
                <canvas id="canvas-new" class="canvas-layer"></canvas>
                <div id="slider" class="hidden"></div>
            </div>

            <div class="flex items-center gap-2">
                <div class="flex items-center gap-2">
                    <span class="squareicon red"></span>
                    <span>削除・変更前</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="squareicon blue"></span>
                    <span>追加・変更後</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="squareicon purple"></span>
                    <span>共通部分</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        var pdfjsLib = window['pdfjs-dist/build/pdf'];
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let pdfOld = null;
        let pdfNew = null;
        let currentPage = 1;
        let scale = 1.5;

        var fileOldInput = document.getElementById('file-old');
        var fileNewInput = document.getElementById('file-new');
        var compBox = document.getElementById('comp-box');
        var canvasOld = document.getElementById('canvas-old');
        var canvasNew = document.getElementById('canvas-new');
        var slider = document.getElementById('slider');
        var statusMsg = document.getElementById('status-message');
        var viewerContainer = document.getElementById('viewer-container');
        var controlPanel = document.getElementById('controlpanel');
        var loading = document.getElementById('loading');
        var panels = document.getElementById('panels');
        var fileInputPanel = document.getElementById('fileinputpanel');
        var fileTabBtn = document.getElementById('file-tab-btn');
        var optionTabBtn = document.getElementById('option-tab-btn');
        var fullscreenCbtn = document.getElementById('fullscreen-cbtn');
        // Fullscreen Toggle
        fullscreenCbtn.onchange = () => {
            if (fullscreenCbtn.checked) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        };
        // Tab Switching
        let currentMode = null;

        function togglePanel(mode) {
            if (currentMode === mode) {
                panels.style.display = 'none';
                currentMode = null;
            } else {
                panels.style.display = 'flex';
                fileInputPanel.style.display = (mode === 'file') ? 'flex' : 'none';
                controlPanel.style.display = (mode === 'option') ? 'flex' : 'none';
                currentMode = mode;
            }
        }

        fileTabBtn.onclick = () => togglePanel('file');
        optionTabBtn.onclick = () => togglePanel('option');


        // Handle File Uploads
        fileOldInput.addEventListener('change', e => loadPDF(e, 'old'));
        fileNewInput.addEventListener('change', e => loadPDF(e, 'new'));

        async function loadPDF(e, type) {
            var file = e.target.files[0];
            if (!file) return;

            var reader = new FileReader();
            reader.onload = async function () {
                var typedarray = new Uint8Array(this.result);
                try {
                    var pdf = await pdfjsLib.getDocument(typedarray).promise;
                    if (type === 'old') pdfOld = pdf;
                    else pdfNew = pdf;

                    checkAndRender();
                } catch (err) {
                    console.error(err);
                    alert("PDFの読み込みに失敗しました。");
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function checkAndRender() {
            if (pdfOld && pdfNew) {
                statusMsg.classList.add('hidden');
                viewerContainer.classList.remove('hidden');
                controlPanel.classList.remove('hidden');

                var totalPages = Math.max(pdfOld.numPages, pdfNew.numPages);
                document.getElementById('total-pages').textContent = totalPages;
                renderPages();
            }
        }

        async function renderPages() {
            loading.classList.remove('hidden');
            document.getElementById('current-page').textContent = currentPage;

            // Render Old
            if (currentPage <= pdfOld.numPages) {
                await renderToCanvas(pdfOld, currentPage, canvasOld, 'red');
            } else {
                clearCanvas(canvasOld);
            }

            // Render New
            if (currentPage <= pdfNew.numPages) {
                await renderToCanvas(pdfNew, currentPage, canvasNew, 'blue');
            } else {
                clearCanvas(canvasNew);
            }

            updateMode();
            loading.classList.add('hidden');
        }

        async function renderToCanvas(pdf, pageNum, canvas, tintColor) {
            var page = await pdf.getPage(pageNum);
            var viewport = page.getViewport({ scale });
            var context = canvas.getContext('2d');

            var targetHeight = window.innerHeight - 60;

            // 2. PDFの元のサイズ（スケール1.0）を取得
            var unscaledViewport = page.getViewport({ scale: 1 });

            // 3. 計算した高さに合わせるための倍率（スケール）を算出
            var dynamicScale = targetHeight / unscaledViewport.height;

            // 4. 計算したスケールでビューポートを生成
            var viewport = page.getViewport({ scale: dynamicScale });
            canvas.height = viewport.height; // これが targetHeight とほぼ同等になる
            canvas.width = viewport.width;   // 比率を維持したまま自動計算される
            compBox.style.height = canvas.height + "px";
            compBox.style.width = canvas.width + "px";
            await page.render({ canvasContext: context, viewport: viewport }).promise;

            // Apply tint for difference visualization
            var imageData = context.getImageData(0, 0, canvas.width, canvas.height);
            var data = imageData.data;

            for (let i = 0; i < data.length; i += 4) {
                // If it's near white, make it transparent so layers can "blend"
                var brightness = (data[i] + data[i + 1] + data[i + 2]) / 3;
                if (brightness > 240) {
                    data[i + 3] = 0;
                } else {
                    // Tinting logic: 
                    // Old version becomes reddish
                    // New version becomes bluish
                    if (tintColor === 'red') {
                        data[i] = 255; data[i + 1] = 50; data[i + 2] = 50;
                    } else {
                        data[i] = 50; data[i + 1] = 50; data[i + 2] = 255;
                    }
                }
            }
            context.putImageData(imageData, 0, 0);
        }

        function clearCanvas(canvas) {
            var context = canvas.getContext('2d');
            context.clearRect(0, 0, canvas.width, canvas.height);
        }

        // Navigation
        document.getElementById('prev-page').onclick = () => {
            if (currentPage > 1) {
                currentPage--;
                renderPages();
            }
        };

        document.getElementById('next-page').onclick = () => {
            var max = Math.max(pdfOld ? pdfOld.numPages : 0, pdfNew ? pdfNew.numPages : 0);
            if (currentPage < max) {
                currentPage++;
                renderPages();
            }
        };
        //keyboard navigation
        window.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') {
                document.getElementById('prev-page').click();
            } else if (e.key === 'ArrowRight') {
                document.getElementById('next-page').click();
            }
        });

        // Modes and Interaction
        var modeRadios = document.getElementsByName('mode');
        modeRadios.forEach(r => r.onchange = updateMode);

        function updateMode() {
            var mode = document.querySelector('input[name="mode"]:checked').value;

            if (mode === 'overlay') {
                slider.classList.add('hidden');
                canvasOld.style.clipPath = 'none';
                canvasNew.style.opacity = '0.7'; // Blend effect
                canvasOld.style.opacity = '0.7';
                canvasNew.style.mixBlendMode = 'multiply';
            } else {
                slider.classList.remove('hidden');
                canvasNew.style.opacity = '1';
                canvasOld.style.opacity = '1';
                canvasNew.style.mixBlendMode = 'normal';
                initSlider();
            }
        }

        function initSlider() {
            var width = compBox.offsetWidth;
            let isDragging = false;

            var move = (x) => {
                var rect = compBox.getBoundingClientRect();
                let pos = (x - rect.left) / rect.width * 100;
                pos = Math.max(0, Math.min(100, pos));
                slider.style.left = pos + '%';
                canvasNew.style.clipPath = `inset(0 0 0 ${pos}%)`;
            };

            slider.style.left = '50%';
            canvasNew.style.clipPath = 'inset(0 0 0 50%)';

            compBox.onmousedown = () => isDragging = true;
            window.onmouseup = () => isDragging = false;
            window.onmousemove = (e) => {
                if (isDragging) move(e.clientX);
            };
            // Touch support
            compBox.ontouchstart = () => isDragging = true;
            window.ontouchend = () => isDragging = false;
            window.ontouchmove = (e) => {
                if (isDragging) move(e.touches[0].clientX);
            };
        }
        document.querySelectorAll('.fip label').forEach(input => {
            const list = input.nextElementSibling;

            input.addEventListener('change', () => {
                list.innerHTML = '';
                [...input.files].forEach(file => {
                    const div = document.createElement('div');
                    div.textContent = file.name;
                    list.prepend(div);
                });
            });
        });
    </script>

</body>

</html>